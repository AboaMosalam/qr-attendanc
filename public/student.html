<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุจูุงุจุฉ ุงูุทูุงุจ - ูุธุงู ุงูุญุถูุฑ</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="nav">
            <a href="/">โ ุงูุฑุฆูุณูุฉ</a>
            <a href="/instructor">ุจูุงุจุฉ ุงููุญุงุถุฑูู</a>
        </div>

        <h1>๐จโ๐ ุจูุงุจุฉ ุงูุทูุงุจ</h1>

        <!-- Alert Messages -->
        <div id="alert-container"></div>

        <!-- Registration Section -->
        <div id="registration-section" class="glass-card">
            <h2>๐ ุชุณุฌูู ุจูุงูุงุช ุงูุทุงูุจ</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">
                ุณุฌู ุจูุงูุงุชู ุฃููุงู ูุชุชููู ูู ุชุณุฌูู ุงูุญุถูุฑ
            </p>

            <form id="registration-form">
                <div class="form-group">
                    <label for="student-name">ุงูุงุณู ุงููุงูู *</label>
                    <input type="text" id="student-name" required placeholder="ุฃุฏุฎู ุงุณูู ุงููุงูู">
                </div>

                <div class="form-group">
                    <label for="student-id">ุงูุฑูู ุงูุฌุงูุนู *</label>
                    <input type="text" id="student-id" required placeholder="ูุซุงู: 20210001">
                </div>

                <div class="form-group">
                    <label for="student-email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู *</label>
                    <input type="email" id="student-email" required placeholder="example@student.edu">
                </div>

                <div class="form-group">
                    <label for="student-phone">ุฑูู ุงููุงุชู</label>
                    <input type="tel" id="student-phone" placeholder="01xxxxxxxxx">
                </div>

                <div class="form-group">
                    <label for="student-department">ุงููุณู *</label>
                    <select id="student-department" required>
                        <option value="">ุงุฎุชุฑ ุงููุณู</option>
                        <option value="CS">ุนููู ุงูุญุงุณุจ</option>
                        <option value="IT">ุชูููููุฌูุง ุงููุนูููุงุช</option>
                        <option value="IS">ูุธู ุงููุนูููุงุช</option>
                        <option value="AI">ุงูุฐูุงุก ุงูุงุตุทูุงุนู</option>
                        <option value="DS">ุนููู ุงูุจูุงูุงุช</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="student-year">ุงูุณูุฉ ุงูุฏุฑุงุณูุฉ *</label>
                    <select id="student-year" required>
                        <option value="">ุงุฎุชุฑ ุงูุณูุฉ</option>
                        <option value="1">ุงูุฃููู</option>
                        <option value="2">ุงูุซุงููุฉ</option>
                        <option value="3">ุงูุซุงูุซุฉ</option>
                        <option value="4">ุงูุฑุงุจุนุฉ</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    ุชุณุฌูู ุงูุจูุงูุงุช
                </button>
            </form>

            <div style="text-align: center; margin-top: 24px;">
                <button id="already-registered-btn" class="btn btn-secondary">
                    ูุฏู ุญุณุงุจ ุจุงููุนู - ุชุณุฌูู ุงูุญุถูุฑ
                </button>
            </div>
        </div>

        <!-- Attendance Section -->
        <div id="attendance-section" class="glass-card hidden">
            <h2>๐ธ ูุณุญ ุฑูุฒ QR</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">
                ุงูุณุญ ุฑูุฒ QR ุงููุนุฑูุถ ูู ุงููุญุงุถุฑุฉ ูุชุณุฌูู ุญุถูุฑู
            </p>

            <div class="form-group">
                <label for="attendance-student-id">ุงูุฑูู ุงูุฌุงูุนู</label>
                <input type="text" id="attendance-student-id" placeholder="ุฃุฏุฎู ุฑููู ุงูุฌุงูุนู">
            </div>

            <button id="start-scan-btn" class="btn btn-success" style="width: 100%; margin-bottom: 20px;">
                ๐ท ุจุฏุก ุงููุณุญ
            </button>

            <!-- QR Scanner -->
            <div id="scanner-container" class="hidden">
                <div id="reader"></div>
            </div>

            <!-- Manual QR Code Input -->
            <div style="margin-top: 30px;">
                <h3>ุฃู ุฃุฏุฎู ุงูุฑูุฒ ูุฏููุงู</h3>
                <div class="form-group">
                    <label for="manual-qr-code">ุฑูุฒ QR</label>
                    <input type="text" id="manual-qr-code" placeholder="ุงูุตู ุงูุฑูุฒ ููุง">
                </div>
                <button id="manual-submit-btn" class="btn btn-primary" style="width: 100%;">
                    ุชุณุฌูู ุงูุญุถูุฑ
                </button>
            </div>

            <div style="text-align: center; margin-top: 24px;">
                <button id="back-to-register-btn" class="btn" style="background: rgba(255,255,255,0.1);">
                    โ ุงูุนูุฏุฉ ููุชุณุฌูู
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let html5QrCode = null;

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.style.animation = 'fadeInUp 0.5s ease-out reverse';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }

        // Registration Form
        document.getElementById('registration-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const studentData = {
                name: document.getElementById('student-name').value,
                studentId: document.getElementById('student-id').value,
                email: document.getElementById('student-email').value,
                phone: document.getElementById('student-phone').value,
                department: document.getElementById('student-department').value,
                year: document.getElementById('student-year').value
            };

            try {
                const response = await fetch(`${API_URL}/students/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('ุชู ุงูุชุณุฌูู ุจูุฌุงุญ! ููููู ุงูุขู ุชุณุฌูู ุงูุญุถูุฑ', 'success');
                    localStorage.setItem('studentId', studentData.studentId);
                    setTimeout(() => showAttendanceSection(), 2000);
                } else {
                    showAlert(data.error || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุณุฌูู', 'error');
                }
            } catch (error) {
                showAlert('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู', 'error');
                console.error('Error:', error);
            }
        });

        // Switch to attendance section
        function showAttendanceSection() {
            document.getElementById('registration-section').classList.add('hidden');
            document.getElementById('attendance-section').classList.remove('hidden');

            const storedStudentId = localStorage.getItem('studentId');
            if (storedStudentId) {
                document.getElementById('attendance-student-id').value = storedStudentId;
            }
        }

        // Already registered button
        document.getElementById('already-registered-btn').addEventListener('click', showAttendanceSection);

        // Back to register button
        document.getElementById('back-to-register-btn').addEventListener('click', () => {
            document.getElementById('attendance-section').classList.add('hidden');
            document.getElementById('registration-section').classList.remove('hidden');
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop();
            }
        });

        // Start QR Scanner
        document.getElementById('start-scan-btn').addEventListener('click', async () => {
            const scannerContainer = document.getElementById('scanner-container');
            const startBtn = document.getElementById('start-scan-btn');

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }

            if (scannerContainer.classList.contains('hidden')) {
                scannerContainer.classList.remove('hidden');
                startBtn.textContent = 'โธ ุฅููุงู ุงููุณุญ';

                try {
                    await html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        onScanSuccess,
                        onScanFailure
                    );
                } catch (err) {
                    showAlert('ุฎุทุฃ ูู ุชุดุบูู ุงููุงููุฑุง', 'error');
                    console.error('Camera error:', err);
                }
            } else {
                scannerContainer.classList.add('hidden');
                startBtn.textContent = '๐ท ุจุฏุก ุงููุณุญ';
                await html5QrCode.stop();
            }
        });

        // QR Scan Success
        function onScanSuccess(decodedText) {
            document.getElementById('manual-qr-code').value = decodedText;
            showAlert('ุชู ูุฑุงุกุฉ ุงูุฑูุฒ ุจูุฌุงุญ!', 'success');

            if (html5QrCode) {
                html5QrCode.stop();
                document.getElementById('scanner-container').classList.add('hidden');
                document.getElementById('start-scan-btn').textContent = '๐ท ุจุฏุก ุงููุณุญ';
            }

            // Auto submit
            setTimeout(() => submitAttendance(decodedText), 1000);
        }

        function onScanFailure(error) {
            // Silent - scanning...
        }

        // Manual Submit
        document.getElementById('manual-submit-btn').addEventListener('click', () => {
            const qrCode = document.getElementById('manual-qr-code').value;
            if (!qrCode) {
                showAlert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูุฒ QR', 'error');
                return;
            }
            submitAttendance(qrCode);
        });

        // Submit Attendance
        async function submitAttendance(qrCode) {
            const studentId = document.getElementById('attendance-student-id').value;

            if (!studentId) {
                showAlert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุฑูู ุงูุฌุงูุนู', 'error');
                return;
            }

            try {
                // First, get session info
                const sessionResponse = await fetch(`${API_URL}/sessions/qr/${qrCode}`);
                const sessionData = await sessionResponse.json();

                if (!sessionResponse.ok) {
                    showAlert(sessionData.error || 'ุฑูุฒ QR ุบูุฑ ุตุญูุญ', 'error');
                    return;
                }

                // Then mark attendance
                const attendanceData = {
                    sessionId: sessionData.id,
                    studentId: studentId,
                    qrCode: qrCode
                };

                const response = await fetch(`${API_URL}/attendance/mark`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(attendanceData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert(`โ ุชู ุชุณุฌูู ุญุถูุฑู ูู: ${sessionData.courseName} - ${sessionData.lectureTitle}`, 'success');
                    document.getElementById('manual-qr-code').value = '';
                } else {
                    showAlert(data.error || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุญุถูุฑ', 'error');
                }
            } catch (error) {
                showAlert('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู', 'error');
                console.error('Error:', error);
            }
        }

        // Check if already registered
        window.addEventListener('load', () => {
            const storedStudentId = localStorage.getItem('studentId');
            if (storedStudentId) {
                // Optionally show a message offering to go to attendance section
                const alert = document.createElement('div');
                alert.className = 'alert alert-info';
                alert.innerHTML = `
                    ูุฑุญุจุงู ${storedStudentId}! 
                    <button onclick="showAttendanceSection()" class="btn btn-primary" style="margin-right: 10px; padding: 8px 16px;">
                        ุชุณุฌูู ุงูุญุถูุฑ โ
                    </button>
                `;
                document.getElementById('alert-container').appendChild(alert);
            }
        });
    </script>
</body>

</html>